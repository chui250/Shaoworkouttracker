<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>5/3/1 Logger - Shao Format</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 12px;
            font-size: 14px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
        }
        .header h1 { font-size: 20px; margin-bottom: 4px; }
        .header p { font-size: 12px; opacity: 0.9; }
        
        /* Auth Section */
        .auth-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 2px solid #667eea;
            text-align: center;
        }
        .auth-section h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        .auth-btn {
            padding: 12px 24px;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        .auth-status {
            margin-top: 12px;
            font-size: 13px;
            color: #666;
        }
        
        /* Config Section */
        .config-section {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
        }
        .config-section label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
        }
        .config-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
        }
        .save-config-btn {
            width: 100%;
            padding: 10px;
            background: #34C759;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* TM Bar */
        .tm-bar {
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
        }
        .tm-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .tm-item { text-align: center; }
        .tm-label { font-size: 10px; color: #666; font-weight: 600; margin-bottom: 2px; }
        .tm-value { font-size: 16px; font-weight: 700; color: #667eea; }
        .tm-edit { 
            font-size: 10px; 
            color: #667eea; 
            cursor: pointer; 
            text-decoration: underline;
            margin-top: 2px;
        }
        
        /* Programme Selector */
        .programme-bar {
            background: #fff;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 2px solid #667eea;
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }
        .programme-bar select {
            padding: 10px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            background: #fff;
        }
        .week-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .week-nav button {
            width: 36px;
            height: 36px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
        }
        .week-nav span {
            font-size: 14px;
            font-weight: 700;
            min-width: 80px;
            text-align: center;
        }
        
        /* Session View */
        .session-view {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e0e0e0;
        }
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }
        .session-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        .session-date {
            font-size: 12px;
            color: #999;
        }
        
        /* Exercise Logging */
        .exercise-log {
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 14px;
            background: #fafafa;
        }
        .exercise-name {
            font-size: 15px;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .exercise-tm {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }
        
        .sets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .set-input {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .set-label {
            font-size: 11px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
        }
        .set-input input {
            padding: 10px 8px;
            border: 2px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }
        .set-input input:focus {
            border-color: #667eea;
            outline: none;
        }
        .set-input input.planned {
            background: #f8f9ff;
            border-color: #667eea;
            color: #667eea;
        }
        
        /* Bottom Actions */
        .bottom-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }
        .bottom-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-save {
            background: #34C759;
            color: #fff;
        }
        .btn-complete {
            background: #667eea;
            color: #fff;
        }
        
        .status-msg {
            text-align: center;
            padding: 10px;
            background: #34C759;
            color: #fff;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 13px;
            display: none;
        }
        .status-msg.error {
            background: #FF3B30;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 600px) {
            .tm-grid { grid-template-columns: repeat(2, 1fr); }
            .programme-bar { grid-template-columns: 1fr; }
            .sets-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí™ 5/3/1 Logger</h1>
        <p>Synced with your Google Sheets tracker</p>
    </div>

    <!-- Auth Section -->
    <div class="auth-section" id="auth-section">
        <h2>üîê Step 1: Connect to Google</h2>
        <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
            Sign in to access your "2026 Workouts" spreadsheet
        </p>
        <button class="auth-btn" onclick="handleAuthClick()">Sign in with Google</button>
        <div class="auth-status" id="auth-status">Ready to connect</div>
    </div>

    <!-- Config Section -->
    <div class="config-section hidden" id="config-section">
        <h3 style="margin-bottom: 12px;">üìä Step 2: Confirm Your Spreadsheet</h3>
        <label for="spreadsheet-id">Spreadsheet ID:</label>
        <input type="text" id="spreadsheet-id" value="1_rnsiidlimWGaqA_llB-debf_EFQq4NDwvHjV0bwqhc">
        <p style="font-size: 11px; color: #999; margin-bottom: 12px;">
            ‚úì Pre-configured with your "2026 Workouts" spreadsheet
        </p>
        <button class="save-config-btn" onclick="saveConfig()">‚úì Connect to Spreadsheet</button>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" class="hidden">
        <!-- Training Maxes -->
        <div class="tm-bar">
            <div class="tm-grid">
                <div class="tm-item">
                    <div class="tm-label">Squat TM</div>
                    <div class="tm-value" id="tm-squat">145kg</div>
                    <div class="tm-edit" onclick="editTM('Squat')">edit</div>
                </div>
                <div class="tm-item">
                    <div class="tm-label">Bench TM</div>
                    <div class="tm-value" id="tm-bench">105kg</div>
                    <div class="tm-edit" onclick="editTM('Bench')">edit</div>
                </div>
                <div class="tm-item">
                    <div class="tm-label">Deadlift TM</div>
                    <div class="tm-value" id="tm-deadlift">160kg</div>
                    <div class="tm-edit" onclick="editTM('Deadlift')">edit</div>
                </div>
                <div class="tm-item">
                    <div class="tm-label">Press TM</div>
                    <div class="tm-value" id="tm-press">77.5kg</div>
                    <div class="tm-edit" onclick="editTM('Press')">edit</div>
                </div>
            </div>
        </div>

        <!-- Programme Selector -->
        <div class="programme-bar">
            <select id="cycle-select" onchange="updateCycle()">
                <option value="1">Cycle 1</option>
                <option value="2">Cycle 2</option>
                <option value="3">Cycle 3</option>
            </select>
            
            <select id="lift-select" onchange="updateLift()">
                <option value="Back squat">Squat</option>
                <option value="Bench press">Bench Press</option>
                <option value="Deadlift">Deadlift</option>
                <option value="Military Press">Press</option>
            </select>
            
            <div class="week-nav">
                <button onclick="prevWeek()">‚Üê</button>
                <span id="week-display">Week 1</span>
                <button onclick="nextWeek()">‚Üí</button>
            </div>
        </div>

        <!-- Session View -->
        <div class="session-view">
            <div class="session-header">
                <div>
                    <div class="session-title" id="session-title">Squat Day - Week 1</div>
                    <div class="session-date" id="session-date"></div>
                </div>
            </div>

            <!-- Single Exercise with All Sets -->
            <div class="exercise-log" id="main-exercise-log">
                <div class="exercise-name">
                    <span id="main-exercise-name">Back Squat</span>
                    <span class="exercise-tm" id="main-exercise-tm">TM: 145kg</span>
                </div>
                
                <!-- Main Sets -->
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 12px; font-weight: 700; color: #667eea; margin-bottom: 8px;">5s PRO (Main Work)</div>
                    <div class="sets-grid" id="main-sets-grid">
                        <!-- Dynamically generated -->
                    </div>
                </div>
                
                <!-- FSL Sets -->
                <div id="fsl-section">
                    <div style="font-size: 12px; font-weight: 700; color: #34C759; margin-bottom: 8px;" id="fsl-label">FSL 5√ó5 @ 65% TM</div>
                    <div class="sets-grid" id="fsl-sets-grid">
                        <!-- Dynamically generated -->
                    </div>
                </div>
            </div>

            <!-- Bottom Actions -->
            <div class="bottom-actions">
                <button class="btn-save" onclick="saveToSheets()">üíæ Save Progress</button>
                <button class="btn-complete" onclick="completeAndNext()">‚úì Complete & Next</button>
            </div>
            
            <div class="status-msg" id="status-msg"></div>
        </div>
    </div>

    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // ========== CLIENT ID CONFIGURED ==========
        const CLIENT_ID = '455247698652-bm67t99gi108vo3tk7260e0cet3ee0ja.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let spreadsheetId = '';
        
        // ========== STATE ==========
        const trainingMaxes = {
            'Back squat': 145,
            'Bench press': 105,
            'Deadlift': 160,
            'Military Press': 77.5
        };
        
        let currentCycle = 1;
        let currentWeek = 1;
        let currentLift = 'Back squat';
        
        // 5/3/1 Templates (5s PRO + FSL)
        const weekTemplates = {
            1: { name: '5s', main: [[65, 5], [75, 5], [85, 5]], fsl: [65, 5, 5] },
            2: { name: '3s', main: [[70, 3], [80, 3], [90, 3]], fsl: [70, 5, 5] },
            3: { name: '5/3/1', main: [[75, 5], [85, 3], [95, 1]], fsl: [75, 5, 5] },
            4: { name: 'Deload', main: [[40, 5], [50, 5], [60, 5]], fsl: null }
        };
        
        // ========== GOOGLE API INIT ==========
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('auth-status').textContent = 'Ready to sign in';
            }
        }
        
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showStatus('Authentication failed: ' + resp.error, true);
                    throw (resp);
                }
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('config-section').classList.remove('hidden');
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        function saveConfig() {
            spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            if (!spreadsheetId) {
                showStatus('Please enter a Spreadsheet ID', true);
                return;
            }
            
            localStorage.setItem('spreadsheetId', spreadsheetId);
            document.getElementById('config-section').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            loadTrainingMaxes();
            renderSession();
            showStatus('Connected! Ready to log workouts', false);
        }
        
        // ========== SHEETS OPERATIONS ==========
        async function loadTrainingMaxes() {
            // TMs stored in Column F of "2026 Workouts"
            // We'll read recent rows to find the latest TM for each lift
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: spreadsheetId,
                    range: '2026 Workouts!B3:F100',  // Date, Exercise, Bodypart, 1RM, TM
                });
                
                const rows = response.result.values;
                if (rows && rows.length > 0) {
                    // Find most recent TM for each main lift
                    const liftNames = ['Back squat', 'Bench press', 'Deadlift', 'Military Press'];
                    rows.reverse();  // Start from most recent
                    
                    liftNames.forEach(lift => {
                        const row = rows.find(r => r[1] && r[1].toLowerCase().includes(lift.toLowerCase()) && r[4]);
                        if (row && row[4]) {
                            trainingMaxes[lift] = parseFloat(row[4]);
                            const liftKey = lift.split(' ')[0].toLowerCase();
                            document.getElementById(`tm-${liftKey}`).textContent = `${row[4]}kg`;
                        }
                    });
                }
            } catch (err) {
                console.error('Error loading TMs:', err);
                showStatus('Using default TMs', false);
            }
        }
        
        async function saveToSheets() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            // ONE ROW with all sets (main + FSL)
            const mainExercise = document.getElementById('lift-select').value;
            const mainTM = trainingMaxes[mainExercise];
            const row = [dateStr, mainExercise, '', '', mainTM];  // Date, Exercise, Bodypart (empty), 1RM (empty), TM
            
            // Add empty columns until J (column 10)
            while (row.length < 9) row.push('');
            
            // Add main sets (starting at column J = index 9)
            const template = weekTemplates[currentWeek];
            for (let i = 0; i < template.main.length; i++) {
                const weightInput = document.querySelector(`#set-${i}-weight`);
                const repsInput = document.querySelector(`#set-${i}-reps`);
                const weight = weightInput ? parseFloat(weightInput.value) : '';
                const reps = repsInput ? parseFloat(repsInput.value) : '';
                
                row.push(weight || '');  // Weight
                row.push(reps || '');    // Reps
                row.push(weight && reps ? weight * reps : '');  // Volume (calculated)
            }
            
            // Add FSL sets (continue in same row)
            if (template.fsl) {
                const [fslPct, fslReps, fslSets] = template.fsl;
                for (let i = 0; i < fslSets; i++) {
                    const setNum = template.main.length + i;  // Continue numbering
                    const weightInput = document.querySelector(`#set-${setNum}-weight`);
                    const repsInput = document.querySelector(`#set-${setNum}-reps`);
                    const weight = weightInput ? parseFloat(weightInput.value) : '';
                    const reps = repsInput ? parseFloat(repsInput.value) : '';
                    
                    row.push(weight || '');
                    row.push(reps || '');
                    row.push(weight && reps ? weight * reps : '');
                }
            }
            
            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: spreadsheetId,
                    range: '2026 Workouts!B:AZ',  // Append to existing data
                    valueInputOption: 'USER_ENTERED',
                    resource: { values: [row] }  // Single row
                });
                
                showStatus('‚úì Saved to Google Sheets!', false);
            } catch (err) {
                console.error('Save error:', err);
                showStatus('Failed to save: ' + err.message, true);
            }
        }
        
        // ========== UI FUNCTIONS ==========
        function renderSession() {
            const lift = currentLift;
            const week = currentWeek;
            const tm = trainingMaxes[lift];
            const template = weekTemplates[week];
            
            // Update header
            document.getElementById('session-title').textContent = 
                `${lift.replace('Back squat', 'Squat').replace('Military Press', 'Press')} - Week ${week} (${template.name})`;
            document.getElementById('session-date').textContent = new Date().toLocaleDateString('en-GB', {
                weekday: 'long', day: 'numeric', month: 'short', year: 'numeric'
            });
            
            // Update main exercise
            document.getElementById('main-exercise-name').textContent = lift;
            document.getElementById('main-exercise-tm').textContent = `TM: ${tm}kg`;
            
            // Render main sets
            const mainGrid = document.getElementById('main-sets-grid');
            mainGrid.innerHTML = '';
            
            template.main.forEach(([pct, reps], idx) => {
                const weight = Math.round((tm * pct / 100) * 2) / 2;
                const setDiv = document.createElement('div');
                setDiv.className = 'set-input';
                setDiv.innerHTML = `
                    <div class="set-label">Set ${idx + 1}</div>
                    <input type="number" step="0.5" placeholder="${weight}" class="planned" id="set-${idx}-weight" value="${weight}">
                    <input type="number" step="1" placeholder="${reps}" id="set-${idx}-reps">
                `;
                mainGrid.appendChild(setDiv);
            });
            
            // Render FSL sets if not deload
            const fslSection = document.getElementById('fsl-section');
            if (template.fsl) {
                fslSection.style.display = 'block';
                const [fslPct, fslReps, fslSets] = template.fsl;
                const fslWeight = Math.round((tm * fslPct / 100) * 2) / 2;
                
                document.getElementById('fsl-label').textContent = `FSL ${fslSets}√ó${fslReps} @ ${fslPct}% TM (${fslWeight}kg)`;
                
                const fslGrid = document.getElementById('fsl-sets-grid');
                fslGrid.innerHTML = '';
                
                for (let i = 0; i < fslSets; i++) {
                    const setNum = template.main.length + i;  // Continue numbering from main sets
                    const setDiv = document.createElement('div');
                    setDiv.className = 'set-input';
                    setDiv.innerHTML = `
                        <div class="set-label">Set ${setNum + 1}</div>
                        <input type="number" step="0.5" placeholder="${fslWeight}" class="planned" id="set-${setNum}-weight" value="${fslWeight}">
                        <input type="number" step="1" placeholder="${fslReps}" id="set-${setNum}-reps">
                    `;
                    fslGrid.appendChild(setDiv);
                }
            } else {
                fslSection.style.display = 'none';
            }
        }
        
        function editTM(lift) {
            const liftKey = lift === 'Squat' ? 'Back squat' : 
                           lift === 'Bench' ? 'Bench press' :
                           lift === 'Press' ? 'Military Press' : 'Deadlift';
            const current = trainingMaxes[liftKey];
            const newTM = prompt(`New TM for ${lift} (current: ${current}kg):`, current);
            if (newTM && !isNaN(newTM)) {
                trainingMaxes[liftKey] = parseFloat(newTM);
                document.getElementById(`tm-${lift.toLowerCase()}`).textContent = `${newTM}kg`;
                renderSession();
            }
        }
        
        function updateCycle() {
            currentCycle = parseInt(document.getElementById('cycle-select').value);
        }
        
        function updateLift() {
            currentLift = document.getElementById('lift-select').value;
            renderSession();
        }
        
        function prevWeek() {
            if (currentWeek > 1) {
                currentWeek--;
                document.getElementById('week-display').textContent = `Week ${currentWeek}`;
                renderSession();
            }
        }
        
        function nextWeek() {
            if (currentWeek < 4) {
                currentWeek++;
                document.getElementById('week-display').textContent = `Week ${currentWeek}`;
                renderSession();
            }
        }
        
        function completeAndNext() {
            saveToSheets();
            
            const lifts = ['Back squat', 'Bench press', 'Deadlift', 'Military Press'];
            const currentIdx = lifts.indexOf(currentLift);
            const nextIdx = (currentIdx + 1) % lifts.length;
            
            if (nextIdx === 0) {
                currentWeek++;
                if (currentWeek > 4) {
                    currentWeek = 1;
                    currentCycle++;
                }
                document.getElementById('week-display').textContent = `Week ${currentWeek}`;
                document.getElementById('cycle-select').value = currentCycle;
            }
            
            currentLift = lifts[nextIdx];
            document.getElementById('lift-select').value = currentLift;
            renderSession();
            
            window.scrollTo(0, 0);
        }
        
        function showStatus(msg, isError) {
            const statusEl = document.getElementById('status-msg');
            statusEl.textContent = msg;
            statusEl.className = 'status-msg' + (isError ? ' error' : '');
            statusEl.style.display = 'block';
            setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        }
        
        // ========== INIT ==========
        window.onload = function() {
            // Default spreadsheet ID
            const defaultSpreadsheetId = '1_rnsiidlimWGaqA_llB-debf_EFQq4NDwvHjV0bwqhc';
            const savedSpreadsheetId = localStorage.getItem('spreadsheetId');
            
            if (savedSpreadsheetId) {
                spreadsheetId = savedSpreadsheetId;
                document.getElementById('spreadsheet-id').value = spreadsheetId;
            } else {
                document.getElementById('spreadsheet-id').value = defaultSpreadsheetId;
            }
            
            gapiLoaded();
            gisLoaded();
        };
    </script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
</body>
</html>
